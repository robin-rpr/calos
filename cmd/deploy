#!/bin/sh

clearly_lib=$(cd "$(dirname "$0")" && pwd)/../../lib
. "${clearly_lib}/_base.sh"

set -e

usage=$(cat <<EOF
Deploy applications using Clearly's distributed runtime.

Usage:

  $ clearly deploy [OPTIONS] APP_NAME
  $ clearly deploy [OPTIONS] -f COMPOSE_FILE APP_NAME

Options:

  -f, --file FILE    specify an alternate compose file (default: docker-compose.yml)
  -h, --help         print this help and exit
  -q, --quiet        make the program more quiet, can be repeated
  -v, --verbose      make the program more verbose, can be repeated

Examples:

  $ clearly deploy myapp
  $ clearly deploy -f production.yml myapp
  $ clearly deploy --file docker-compose.prod.yml myapp

The deploy command reads a Docker Compose file and sends the services
configuration to the Clearly daemon for deployment across the cluster.
EOF
)

compose_file="docker-compose.yml"
app_name=""

# Parse arguments
while [ $# -gt 0 ]; do
    opt=$1; shift
    if ! parse_basic_arg "$opt"; then
        case $opt in
            -f|--file)
                [ $# -gt 0 ] || FATAL "missing argument for --file"
                compose_file=$1
                shift
                ;;
            -*)
                INFO "invalid option: ${opt}"
                usage
                ;;
            *)
                [ -z "$app_name" ] || FATAL "duplicate app name: ${opt}"
                app_name="$opt"
                ;;
        esac
    fi
done

[ -n "$app_name" ] || FATAL "app name required"

# Check if compose file exists
[ -f "$compose_file" ] || FATAL "compose file not found: ${compose_file}"

# Check if daemon is running by trying to connect to the API
daemon_url="http://127.0.0.1:8080"
if ! curl -s --max-time 5 "$daemon_url/api/containers" > /dev/null 2>&1; then
    FATAL "Clearly daemon not running. Start it with: clearly daemon"
fi

# Read and validate the compose file
VERBOSE "reading compose file: ${compose_file}"

# Just send the compose file as-is to the API, no validation, using curl and jq if available
response=$(curl -s -X POST \
    -H "Content-Type: application/x-yaml" \
    --data-binary @"$compose_file" \
    "$daemon_url/api/deploy")

# Print the API response as-is
echo "$response"

INFO "done"

