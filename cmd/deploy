#!/bin/sh

clearly_lib=$(cd "$(dirname "$0")" && pwd)/../../lib
. "${clearly_lib}/_base.sh"

set -e

usage=$(cat <<EOF
Deploy an application to the cluster.

Usage:

  $ clearly deploy [OPTIONS] NAME
  $ clearly deploy [OPTIONS] -f COMPOSE_FILE NAME

Options:

  -f, --file FILE    specify an alternate compose file (default: docker-compose.yml)
  -h, --help         print this help and exit

Examples:

  $ clearly deploy myapp
  $ clearly deploy -f production.yml myapp
  $ clearly deploy --file docker-compose.prod.yml myapp

The deploy command reads a Docker Compose file and sends the services
configuration to the Clearly daemon for deployment across the cluster.
EOF
)

compose_file="docker-compose.yml"
name=""

# Parse arguments.
while [ $# -gt 0 ]; do
    opt=$1; shift
    if [ "$opt" = "-h" ] || [ "$opt" = "--help" ]; then
        echo "$usage"
        exit 0
    fi
    case $opt in
        -f|--file)
            [ $# -gt 0 ] || FATAL "missing argument for --file"
            compose_file=$1
            shift
            ;;
        -*)
            INFO "invalid option: ${opt}"
            echo "$usage"
            exit 1
            ;;
        *)
            [ -z "$name" ] || FATAL "duplicate name: ${opt}"
            name="$opt"
            ;;
    esac
done

[ -n "$name" ] || FATAL "name required"

# Check if compose file exists.
[ -f "$compose_file" ] || FATAL "compose file not found: ${compose_file}"

# Check if daemon is running by trying to connect to the API.
daemon_url="http://127.0.0.1:8080"
if ! curl -s --max-time 5 "$daemon_url/api/containers" > /dev/null 2>&1; then
    FATAL "daemon is not running (hint: do 'service clearly start')"
fi

# Send the compose file as-is.
response=$(curl -s -X POST \
    -H "Content-Type: application/x-yaml" \
    --data-binary @"$compose_file" \
    "$daemon_url/api/deploy?name=$name")

# Print error if present, otherwise OK.
if echo "$response" | grep -q '"error"'; then
    FATAL "$response"
fi

INFO "done"