#!/bin/sh

set -u

clearly_runtime="${CLEARLY_RUNTIME_STORAGE:-/var/lib/clearly/runtime}"
clearly_lib=$(cd "$(dirname "$0")" && pwd)/../../lib
. "${clearly_lib}/_base.sh"

json_output="${1:-}" # "--json" or empty

usage=$(cat <<EOF
List all containers on the system.

Usage:

  $ clearly list [OPTIONS]

Options:

  --json              output in JSON format
  -h, --help          print this help and exit

Examples:

  $ clearly list
  $ clearly list --json

The list command shows all containers currently managed by the Clearly
runtime, including their container ID, IP address, and current status.
EOF
)

# Parse arguments
while [ $# -gt 0 ]; do
    opt=$1; shift
    if [ "$opt" = "-h" ] || [ "$opt" = "--help" ]; then
        echo "$usage"
        exit 0
    fi
    case $opt in
        --json)
            json_output="--json"
            ;;
        -*)
            FATAL "invalid option: ${opt}"
            ;;
        *)
            FATAL "unexpected argument: ${opt}"
            ;;
    esac
done

# If runtime dir doesn't exist: mimic original behavior
if [[ ! -d "$clearly_runtime" ]]; then
  if [[ "$json_output" == "--json" ]]; then
    printf '[]\n'
  else
    printf '%-20s\t%-20s\t%-20s\t%-10s\t%s\n' "CONTAINER ID" "IMAGE" "IP ADDRESS" "STATUS" "PORTS"
  fi
  exit 0
fi

space=20 # Minimum width.
shopt -s nullglob
for dir in "$clearly_runtime"/*/; do
  img=$(<"${dir}img")
  (( w = ${#img} + 2, w > space )) && space=$w
done

if [[ "$json_output" == "--json" ]]; then
  printf '[\n'
else
  printf '%-20s\t%-*s\t%-20s\t%-10s\t%s\n' "CONTAINER ID" "$space" "IMAGE" "IP ADDRESS" "STATUS" "PORTS"
fi

first_item=1

shopt -s nullglob
for dir in "$clearly_runtime"/*/; do

  id="${dir%/}"; id="${id##*/}"

  pid=$(<"${dir}pid")
  net=$(<"${dir}net")
  img=$(<"${dir}img")

  ports=""
  # Determine ports from both tcp and udp files
  for proto in tcp udp; do
    file="${dir}${proto}"
    if [[ -f "$file" && -s "$file" ]]; then
      while IFS= read -r line; do
        [[ $line ]] && ports+="${ports:+, }${line}/$proto"
      done < "$file"
    fi
  done

  # Determine status (Running / Stopped / Unknown)
  if kill -0 "$pid" 2>/dev/null; then
    status="Running"
  elif [[ ! -e "/proc/$pid" ]]; then
    status="Stopped"
    ports=""
    net=""
  else
    status="Unknown"
    ports=""
    net=""
  fi

  if [[ "$json_output" == "--json" ]]; then
    if (( first_item == 0 )); then
      printf ',\n'
    fi
    printf '  {"id": "%s", "image": "%s", "ip_address": "%s", "status": "%s", "ports": "%s"}' "$id" "$img" "$net" "$status" "$ports"
    first_item=0
  else
    printf '%-20s\t%-*s\t%-20s\t%-10s\t%s\n' "$id" "$space" "$img" "${net:--}" "$status" "${ports:--}"
  fi
done

if [[ "$json_output" == "--json" ]]; then
  printf '\n]\n'
fi