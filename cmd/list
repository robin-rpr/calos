#!/bin/sh

set -u

clearly_runtime="${CLEARLY_RUNTIME_STORAGE:-/var/tmp/clearly/runtime}"
json_output="${1:-}" # "--json" or empty

usage=$(cat <<EOF
List all containers on the system.

Usage:

  $ clearly list [OPTIONS]

Options:

  --json              output in JSON format
  -h, --help          print this help and exit

Examples:

  $ clearly list
  $ clearly list --json

The list command shows all containers currently managed by the Clearly
runtime, including their container ID, IP address, and current status.
EOF
)

# Parse arguments
while [ $# -gt 0 ]; do
    opt=$1; shift
    if [ "$opt" = "-h" ] || [ "$opt" = "--help" ]; then
        echo "$usage"
        exit 0
    fi
    case $opt in
        --json)
            json_output="--json"
            ;;
        -*)
            echo "invalid option: ${opt}" >&2
            echo "$usage" >&2
            exit 1
            ;;
        *)
            echo "unexpected argument: ${opt}" >&2
            echo "$usage" >&2
            exit 1
            ;;
    esac
done

# If runtime dir doesn't exist: mimic original behavior
if [[ ! -d "$clearly_runtime" ]]; then
  if [[ "$json_output" == "--json" ]]; then
    printf '[]\n'
  else
    printf 'CONTAINER ID\tIP ADDRESS\tSTATUS\n'
  fi
  exit 0
fi

if [[ "$json_output" == "--json" ]]; then
  printf '[\n'
else
  # Header with fixed widths (like the C version when dir exists)
  printf '%-20s\t%-15s\t%s\n' "CONTAINER ID" "IP ADDRESS" "STATUS"
fi

first_item=1

for dir in "$clearly_runtime"/*/; do

  id="${dir%/}"; id="${id##*/}"

  pid=$(<"${dir}pid")
  ip=$(<"${dir}net")

  # Determine status (Running / Stopped / Unknown)
  if kill -0 "$pid" 2>/dev/null; then
    status="Running"
  elif [[ ! -e "/proc/$pid" ]]; then
    status="Stopped"
  else
    status="Unknown"
  fi

  if [[ "$json_output" == "--json" ]]; then
    if (( first_item == 0 )); then
      printf ',\n'
    fi
    printf '  {"id": "%s", "ip_address": "%s", "status": "%s"}' "$id" "$ip" "$status"
    first_item=0
  else
    printf '%-20s\t%-15s\t%s\n' "$id" "$ip" "$status"
  fi
done

if [[ "$json_output" == "--json" ]]; then
  printf '\n]\n'
fi