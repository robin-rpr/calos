{% extends 'main.html' %}

{% block title %}
Clearly
{% endblock %}

{% block header %}
<!-- Empty -->
{% endblock %}

{% block sidebar %}
<!-- Empty -->
{% endblock %}

{% block footer %}
<!-- Empty -->
{% endblock %}

{% block content %}
<div class="content__index">
    <div class="index__header">
        <div class="header__container">
            <h1 class="header__title">Dashboard</h1>
        </div>
    </div>
    <div class="index__status">
        <div class="status__item">
            <div class="item__title">Active Studios</div>
            <div class="item__value">1</div>
        </div>
        <div class="status__item">
            <div class="item__title">Machines</div>
            <div class="item__value">2</div>
        </div>
    </div>
    <div class="index__tabs">
        <div class="tabs__container">
            <div class="container__tabs" id="tabs">
                <div class="tab__item tab__item--active" target="recent">
                    Recent
                </div>
                <div class="tab__item" target="favourite">
                    Favourite
                </div>
            </div>
        </div>
    </div>
    <div class="index__content">
        <div class="content__container">
            <div class="container__content">
                <div class="content__panel" id="recent" aria-labelledby="tab-recent">
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    /* Tabs */
    const tab = 'recent';
    const tabs = document.querySelectorAll('.tab__item');
    const panels = document.querySelectorAll('.content__panel');

    function switchTab(targetId) {
        if (targetId !== tab) {
            history.replaceState(null, null, `#${targetId}`);
        } else {
            history.replaceState(null, null, window.location.pathname);
        }

        tabs.forEach(tab => {
            tab.classList.toggle('tab__item--active', tab.getAttribute('target') === targetId);
        });

        panels.forEach(panel => {
            panel.style.display = panel.id === targetId ? 'block' : 'none';
        });
    }

    tabs.forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab.getAttribute('target')));
    });

    const handleHashChange = () => switchTab(window.location.hash.slice(1) || tab);
    window.addEventListener('hashchange', handleHashChange);
    handleHashChange();
</script>
<script>
    /* Fetch */
    Promise.all([
        fetch(`/api/containers?filter=labels:type:studio`).then(r => r.json())
    ]).then(([response]) => {
        if (!response.success) {
            console.error(response.error);
            return;
        }

        document.getElementById('recent').innerHTML = Object.entries(response.containers)
            .map(([id, container]) => `
            <a class="panel__item" href="/studio/${container.id}">
                <button class="item__more">
                    <i class="fa-kit fa-more"></i>
                </button>
                <div style="font-size: 0.875rem;" class="item__icon">
                    <i class="fa-kit fa-studio"></i>
                </div>
                <div class="item__name">${container.id}</div>
                <div class="item__config">
                    <i class="fa-kit fa-cpu"></i>16 CPU
                    <i class="fa-kit fa-nvidia"></i>RTX 3090
                </div>
                <div class="item__status item__status--${container.status.toLowerCase()}">
                    <svg viewBox="0 0 80 80" fill="none" role="img" xmlns="http://www.w3.org/2000/svg" width="24px" height="24px">
                        <mask id="mask__marble" maskUnits="userSpaceOnUse" x="0" y="0" width="80" height="80">
                            <rect width="80" height="80" rx="160" fill="#FFFFFF"></rect>
                        </mask>
                        <g mask="url(#mask__marble)"><rect width="80" height="80" fill="#44c2f4"></rect>
                            <path filter="url(#prefix__filter0_f)" d="M32.414 59.35L50.376 70.5H72.5v-71H33.728L26.5 13.381l19.057 27.08L32.414 59.35z" fill="#6da1f0" transform="translate(2 2) rotate(10 40 40) scale(1.5)"></path>
                            <path filter="url(#prefix__filter0_f)" d="M22.216 24L0 46.75l14.108 38.129L78 86l-3.081-59.276-22.378 4.005 12.972 20.186-23.35 27.395L22.215 24z" fill="#dee8eb" transform="translate(3 3) rotate(195 40 40) scale(1.5)" style="mix-blend-mode: overlay;"></path>
                        </g>
                        <defs>
                            <filter id="prefix__filter0_f" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                                <feFlood flood-opacity="0" result="BackgroundImageFix"></feFlood>
                                <feBlend in="SourceGraphic" in2="BackgroundImageFix" result="shape"></feBlend>
                                <feGaussianBlur stdDeviation="7" result="effect1_foregroundBlur"></feGaussianBlur>
                            </filter>
                        </defs>
                    </svg>
                    ${container.status.replace('Running', 'Active')}
                </div>
                <div class="item__date">
                    34 minutes ago
                </div>
            </a>
        `).join('');
        
        // Execute all scripts asynchronously after injection
        document.querySelectorAll('#studios-list script[async]').forEach(script => {
            setTimeout(() => {
                eval(script.textContent);
            }, 0);
        });
    });
</script>
{% endblock %}
