name: Publish

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [fedora:40, rockylinux:9]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up ${{ matrix.os }} container
        run: |
          docker run -d --name builder ${{ matrix.os }} bash -c "tail -f /dev/null"
          docker exec builder dnf install -y 'dnf-command(config-manager)'
          docker exec builder dnf install -y epel-release
          docker exec builder dnf install -y \
            autoconf \
            automake \
            libtool \
            rpm-build \
            gcc \
            rsync \
            bash \
            libseccomp-devel \
            squashfuse-devel \
            libmnl-devel \
            libnftnl-devel \
            libnl3-devel \
            libcap-devel \
            fuse3-devel \
            json-c-devel \
            python3 \
            python3-devel \
            python3-setuptools \
            python3-lark-parser \
            python3-sphinx \
            python3-sphinx_rtd_theme \
            python3-libsass \
            python3-requests \
            python3-jinja2 \
            python3-wheel \
            python3-cython \
            git

      - name: Build RPM for ${{ matrix.os }}
        run: |
          # Copy source to container
          docker cp . builder:/root/clearly
          
          # Get version from tag or git describe
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            RELEASE=1
          else
            # For non-tag builds, create a dev version from git describe.
            # checkout action needs `fetch-depth: 0` for this to work properly.
            git fetch --tags --force
            GIT_DESCRIBE=$(git describe --tags --always --dirty)
            VERSION=$(echo "$GIT_DESCRIBE" | sed -e 's/^v//' -e 's/-/~/; s/-/.g/')
            RELEASE=0
          fi
          
          # Build RPM inside container
          docker exec builder bash -c "
            set -x
            set -e

            # Set python to python3.
            export PYTHON=python3

            # Set up the git repository.
            git config --global --add safe.directory /root/clearly
            cd /root/clearly

            # Create the build system.
            ./autogen.sh

            # Configure the build system.
            ./configure

            # Build the distribution tarball.
            make dist
            
            # Build all the targets.
            make
            
            # Find the generated tarball.
            ORIGINAL_TARBALL=\$(ls clearly-*.tar.gz)
            
            # Unpack it to rename the internal directory.
            tar -xzf \"\$ORIGINAL_TARBALL\"
            
            # Find the unpacked directory name.
            ORIGINAL_DIR=\$(ls -d clearly-*/)
            
            # Rename the directory to match the version.
            mv \"\$ORIGINAL_DIR\" \"clearly-$VERSION\"
            
            # Create a VERSION file in the source so it is remembered.
            echo \"$VERSION\" > \"clearly-$VERSION/VERSION\"
            
            # Repack the tarball with the correct internal directory name.
            tar -czf \"clearly-$VERSION.tar.gz\" \"clearly-$VERSION\"

            # Place the new, corrected tarball where rpmbuild can find it.
            mkdir -p /root/rpmbuild/SOURCES
            mv \"clearly-$VERSION.tar.gz\" /root/rpmbuild/SOURCES/

            # Create spec file with version and release.
            sed 's/@VERSION@/$VERSION/g; s/@RELEASE@/$RELEASE/g' packaging/fedora/clearly.spec > clearly.spec
            
            # Build the binary and source RPMs.
            rpmbuild -ba clearly.spec
          "
          
          docker cp builder:/root/rpmbuild/RPMS ./rpms
          docker cp builder:/root/clearly/doc/html ./html

          # Move install.sh to the distilled root html directory.
          mv ./html/_static/install.sh ./html/install.sh


      - name: Upload RPM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rpms-${{ matrix.os }}
          path: ./rpms

      - name: Upload HTML Artifact
        uses: actions/upload-artifact@v4
        if: matrix.os == matrix.os[0]
        with:
          name: html
          path: ./html

  gemfury:
    name: Gemfury
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [fedora:40, rockylinux:9]

    permissions:
        pages: write
        id-token: write
        contents: read

    steps:
      - name: Download RPM Artifact
        uses: actions/download-artifact@v4
        with:
          name: rpms-${{ matrix.os }}
          path: ./rpms

      - name: Upload to Gemfury
        if: startsWith(github.ref, 'refs/tags/') 
        run: |
          for rpm in ./rpms/**/*.rpm; do
            echo "Uploading $rpm to Gemfury..."
            curl -F package=@$rpm https://${{ secrets.GEMFURY_TOKEN }}@push.fury.io/clearly/
          done

  pages:
    name: Pages
    needs: gemfury
    runs-on: ubuntu-latest

    permissions:
        pages: write
        id-token: write
        contents: read

    steps:
      - name: Download HTML Artifact
        uses: actions/download-artifact@v4
        if: matrix.os == matrix.os[0]
        with:
          name: html
          path: ./html

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        if: startsWith(github.ref, 'refs/tags/')
        with:
          path: ./html

      - name: Publish to GitHub Pages
        if: startsWith(github.ref, 'refs/tags/')
        id: deployment
        uses: actions/deploy-pages@v4