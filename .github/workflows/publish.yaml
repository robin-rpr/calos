name: Publish

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build and Publish
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Fedora container
        run: |
          docker run -d --name fedora-builder fedora:39 bash -c "tail -f /dev/null"
          docker exec fedora-builder dnf install -y \
            autoconf \
            automake \
            libtool \
            rpm-build \
            gcc \
            rsync \
            bash \
            libseccomp-devel \
            squashfuse-devel \
            libmnl-devel \
            libnftnl-devel \
            libnl3-devel \
            libcap-devel \
            fuse3-devel \
            json-c-devel \
            python3 \
            python3-devel \
            python3-setuptools \
            python3-lark-parser \
            python3-sphinx \
            python3-sphinx_rtd_theme \
            python3-libsass \
            python3-requests \
            python3-jinja2 \
            python3-wheel \
            python3-cython \
            git

      - name: Build RPM
        run: |
          # Copy source to container
          docker cp . fedora-builder:/root/clearly
          
          # Get version from tag or use HEAD
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            RELEASE=1
          else
            VERSION=HEAD
            RELEASE=0
          fi
          
          # Build RPM inside container
          docker exec fedora-builder bash -c "
            set -x
            set -e

            export PYTHON=python3

            # Set up the git repository.
            git config --global --add safe.directory /root/clearly
            cd /root/clearly

            # Create the build system.
            ./autogen.sh

            # Configure the build system.
            ./configure
            make dist
            
            # Find the generated tarball.
            ORIGINAL_TARBALL=\$(ls clearly-*.tar.gz)
            
            # Unpack it to rename the internal directory.
            tar -xzf \"\$ORIGINAL_TARBALL\"
            
            # Find the unpacked directory name.
            ORIGINAL_DIR=\$(ls -d clearly-*/)
            
            # Rename the directory to match the version.
            mv \"\$ORIGINAL_DIR\" \"clearly-$VERSION\"
            
            # Repack the tarball with the correct internal directory name.
            tar -czf \"clearly-$VERSION.tar.gz\" \"clearly-$VERSION\"

            # Place the new, corrected tarball where rpmbuild can find it.
            mkdir -p /root/rpmbuild/SOURCES
            mv \"clearly-$VERSION.tar.gz\" /root/rpmbuild/SOURCES/

            # Create spec file with version and release.
            sed 's/@VERSION@/$VERSION/g; s/@RELEASE@/$RELEASE/g' packaging/fedora/clearly.spec > clearly.spec
            
            # Build the binary and source RPMs.
            rpmbuild -ba clearly.spec
          "
          
          # Copy RPMs back to the runner
          docker cp fedora-builder:/root/rpmbuild/RPMS ./rpms
          docker cp fedora-builder:/root/rpmbuild/SRPMS ./srpms

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: clearly-rpms
          path: |
            ./rpms/**/*.rpm
            ./srpms/*.rpm
          retention-days: 30

      - name: Publish to Gemfury
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          for rpm in ./rpms/**/*.rpm; do
            echo "Uploading $rpm to Gemfury..."
            curl -F package=@$rpm https://${{ secrets.GEMFURY_TOKEN }}@push.fury.io/clearly/
          done 