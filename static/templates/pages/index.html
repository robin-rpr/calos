{% extends 'base.html' %}

{% block title %}
Clearly
{% endblock %}

{% block sidebar %}
<!-- Empty -->
{% endblock %}

{% block header %}
<!-- Empty -->
{% endblock %}

{% block content %}
<div class="content__index">
    <div class="index__header">
        <div class="header__container">
            <svg class="header__image" draggable="false">
                <use xlink:href="/static/images/sprite.svg#shape-1"></use>
            </svg>
            <div class="header__content">
                <h1 class="content__title">
                    Stratum
                </h1>
                <div class="content__description">
                    Machine learning / AI / Data processing / Change in Settings
                </div>
            </div>
        </div>
    </div>
    <div class="index__tabs">
        <div class="tabs__container">
            <div class="container__tabs" id="tabs">
                <div class="tab__item tab__item--active" target="resources">
                    Resources
                </div>
                <div class="tab__item" target="activity">
                    Activity
                </div>
                <div class="tab__item" target="settings">
                    Settings
                </div>
            </div>
        </div>
    </div>
    <div class="index__content">
        <div class="content__container">
            <div class="container__content">
                <div class="content__panel" id="resources" aria-labelledby="tab-resources">
                    <!-- Studios -->
                    <div class="panel__title">Studios</div>
                    <div class="panel__list" id="studios-list"></div>
                    <!-- Containers -->
                    <div class="panel__title">Containers</div>
                    <div class="panel__list" id="containers-list"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    /* Tabs */
    const tabs = document.querySelectorAll('.tab__item');
    const panels = document.querySelectorAll('.content__panel');

    function switchTab(targetId) {
        if (targetId !== 'resources') {
            history.replaceState(null, null, `#${targetId}`);
        } else {
            history.replaceState(null, null, window.location.pathname);
        }

        tabs.forEach(tab => {
            tab.classList.toggle('tab__item--active', tab.getAttribute('target') === targetId);
        });

        panels.forEach(panel => {
            panel.style.display = panel.id === targetId ? 'block' : 'none';
        });
    }

    tabs.forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab.getAttribute('target')));
    });

    const handleHashChange = () => switchTab(window.location.hash.slice(1) || 'resources');
    window.addEventListener('hashchange', handleHashChange);
    handleHashChange();
</script>
<script>
    // Studios
    Promise.all([
        fetch(`/api/studios`).then(r => r.json())
    ]).then(([studios]) => {
        if (!studios.success) {
            console.error(studios.error);
            return;
        }

        document.getElementById('studios-list').innerHTML = studios.studios.map(studio => `
            <a class="list__item" href="/studio/${studio.id}">
                <div class="item__status item__status--${studio.status}"></div>
                <div class="item__icon item__icon--enlarged">
                    <i class="fa-kit fa-studio"></i>
                </div>
                <div class="item__name">${studio.id}</div>
                <button class="item__more">
                    <i class="fa-sharp fa-light fa-ellipsis"></i>
                </button>
            </a>
        `).join('');
    });
</script>
<script>
    // Containers
    Promise.all([
        fetch(`/api/containers`).then(r => r.json())
    ]).then(([containers]) => {
        if (!containers.success) {
            console.error(containers.error);
            return;
        }

        document.getElementById('containers-list').innerHTML = containers.containers.map(container => `
            <a class="list__item" href="/container/${container.id}">
                <div class="item__status item__status--${container.status}"></div>
                <div class="item__icon">
                    <i class="fa-kit fa-container"></i>
                </div>
                <div class="item__name">${container.id}</div>
                <div class="item__ip-address">${container.ip}</div>
                <div class="item__ports">
                    ${Object.entries(container.publish).map(([host, container]) => `
                    <button class="ports__item" onclick="event.preventDefault(); window.open('${window.location.protocol}//${window.location.hostname}:${host}', '_blank')">
                        <i class="fa-kit fa-arrow-up-right-from-square"></i>
                        ${host}:${container}
                    </button>
                    `).join('')}
                </div>
                <div class="item__image">${container.image}</div>
                <button class="item__more">
                    <i class="fa-sharp fa-light fa-ellipsis"></i>
                </button>
            </a>
        `).join('');
    });
</script>
{% endblock %}
