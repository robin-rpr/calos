{% extends 'main.html' %}

{% block title %}
Clearly
{% endblock %}

{% block sidebar %}
<!-- Empty -->
{% endblock %}

{% block header %}
<!-- Empty -->
{% endblock %}

{% block content %}
<div class="content__index">
    <div class="index__header">
        <div class="header__container">
            <h1 class="header__title">Dashboard</h1>
        </div>
    </div>
    <div class="index__tabs">
        <div class="tabs__container">
            <div class="container__tabs" id="tabs">
                <div class="tab__item tab__item--active" target="resources">
                    Resources
                </div>
                <div class="tab__item" target="activity">
                    Activity
                </div>
                <div class="tab__item" target="settings">
                    Settings
                </div>
            </div>
        </div>
    </div>
    <div class="index__content">
        <div class="content__container">
            <div class="container__content">
                <div class="content__panel" id="resources" aria-labelledby="tab-resources">
                    <!-- Studios -->
                    <div class="panel__title">Studios</div>
                    <div class="panel__list" id="studios-list"></div>
                    <!-- Containers -->
                    <div class="panel__title">Containers</div>
                    <div class="panel__list" id="containers-list"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    /* Tabs */
    const tabs = document.querySelectorAll('.tab__item');
    const panels = document.querySelectorAll('.content__panel');

    function switchTab(targetId) {
        if (targetId !== 'resources') {
            history.replaceState(null, null, `#${targetId}`);
        } else {
            history.replaceState(null, null, window.location.pathname);
        }

        tabs.forEach(tab => {
            tab.classList.toggle('tab__item--active', tab.getAttribute('target') === targetId);
        });

        panels.forEach(panel => {
            panel.style.display = panel.id === targetId ? 'block' : 'none';
        });
    }

    tabs.forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab.getAttribute('target')));
    });

    const handleHashChange = () => switchTab(window.location.hash.slice(1) || 'resources');
    window.addEventListener('hashchange', handleHashChange);
    handleHashChange();
</script>
<script>
    // Studios
    Promise.all([
        fetch(`/api/containers?filter=labels:type:studio`).then(r => r.json())
    ]).then(([response]) => {
        if (!response.success) {
            console.error(response.error);
            return;
        }

        document.getElementById('studios-list').innerHTML = Object.entries(response.containers)
            .map(([id, container]) => `
            <a class="list__item" href="/studio/${container.id}">
                <div class="item__header">
                    <div class="header__name">${container.id}</div>
                </div>
                <div class="item__content" id="containers-${container.id}">
                    <script async>
                        try {
                            // Open WebSocket proxy
                            const secure = window.location.protocol == 'https:';
                            const ws = new WebSocket(
                                \`\${secure ? 'wss' : 'ws'}://\${window.location.host}/api/containers/${container.id}/proxy/8080\`
                            );
                            
                            ws.onmessage = (event) => {
                                const data = JSON.parse(event.data);
                                if (data.success) {
                                    // Use the proxy port to fetch containers
                                    fetch(\`\${secure ? 'https' : 'http'}://\${window.location.hostname}:\${data.proxy}/api/containers\`)
                                        .then(r => r.json())
                                        .then(data => {
                                            console.log(data);
                                            data.containers = [
                                                {
                                                    id: 'vscode',
                                                    image: 'codercom/code-server:latest',
                                                    status: 'Running'
                                                },
                                                {
                                                    id: 'jupyter',
                                                    image: 'jupyter/minimal-notebook:latest',
                                                    status: 'Running'
                                                },
                                                {
                                                    id: 'tensorflow',
                                                    image: 'tensorflow/tensorflow:latest',
                                                    status: 'Running'
                                                }
                                            ]
                                            const containers = (data.containers || []).map(c => {
                                                let img = 'favicon.svg';
                                                switch (c.image.split(':')[0]) {
                                                    case 'codercom/code-server': img = 'vscode.svg'; break;
                                                    case 'jupyter/minimal-notebook': img = 'jupyter.svg'; break;
                                                    case 'tensorflow/tensorflow': img = 'tensorflow.svg'; break;
                                                }
                                                return '<img src="/static/images/' + img + '"></img>';
                                            }).join(' ');
                                            document.getElementById('containers-${container.id}').innerHTML = containers;
                                            
                                            // Close WebSocket after getting result
                                            ws.close();
                                        })
                                        .catch(() => {
                                            console.warn("Couldn't load containers");
                                            ws.close();
                                        });
                                } else {
                                    console.error("Proxy error:", data.error);
                                    ws.close();
                                }
                            };
                            
                            ws.onerror = () => {
                                console.warn("Couldn't connect to proxy");
                            };
                        } catch (e) {
                            console.warn("Couldn't load containers");
                        }
                    <\/script>
                </div>
                <div class="item__footer">
                    <div class="footer__status">
                        <div class="status__icon status__icon--${container.status.toLowerCase()}"></div>
                        <div class="status__name">${container.status}</div>
                    </div>
                </div>
            </a>
        `).join('');
        
        // Execute all scripts asynchronously after injection
        document.querySelectorAll('#studios-list script[async]').forEach(script => {
            setTimeout(() => {
                eval(script.textContent);
            }, 0);
        });
    });
</script>
<script>
    // Containers
    Promise.all([
        fetch(`/api/containers?filter=labels:type:`).then(r => r.json())
    ]).then(([response]) => {
        if (!response.success) {
            console.error(response.error);
            return;
        }

        document.getElementById('containers-list').innerHTML = Object.entries(response.containers)
            .map(([id, container]) => `
            <a class="list__item" href="/container/${container.id}">
                <div class="item__status item__status--${container.status.toLowerCase()}"></div>
                <div class="item__icon">
                    <i class="fa-kit fa-container"></i>
                </div>
                <div class="item__name">${container.id}</div>
                <div class="item__ip">${container.ip}</div>
                <div class="item__ports">
                    ${Object.entries(container.ports || {}).map(([host, container]) => `
                    <button class="ports__item" onclick="event.preventDefault(); window.open('${window.location.protocol}//${window.location.hostname}:${host}', '_blank')">
                        <i class="fa-kit fa-arrow-up-right-from-square"></i>
                        ${host}:${container}
                    </button>
                    `).join('')}
                </div>
                <div class="item__image">${container.image || ''}</div>
                <button class="item__more">
                    <i class="fa-sharp fa-light fa-ellipsis"></i>
                </button>
            </a>
        `).join('');
    });
</script>
{% endblock %}
