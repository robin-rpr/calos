{% extends 'main.html' %}

{% block title %}
Clearly
{% endblock %}

{% block sidebar %}
<!-- Empty -->
{% endblock %}

{% block header %}
<!-- Empty -->
{% endblock %}

{% block content %}
<div class="content__index">
    <div class="index__header">
        <div class="header__container">
            <h1 class="header__title">Dashboard</h1>
        </div>
    </div>
    <div class="index__status">
        <div class="status__item">
            <div class="item__title">Active Studios</div>
            <div class="item__value">1</div>
        </div>
        <div class="status__item">
            <div class="item__title">Machines</div>
            <div class="item__value">2</div>
        </div>
    </div>
    <div class="index__tabs">
        <div class="tabs__container">
            <div class="container__tabs" id="tabs">
                <div class="tab__item tab__item--active" target="recent">
                    Recent
                </div>
                <div class="tab__item" target="favourite">
                    Favourite
                </div>
            </div>
        </div>
    </div>
    <div class="index__content">
        <div class="content__container">
            <div class="container__content">
                <div class="content__panel" id="recent" aria-labelledby="tab-recent">
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    /* Tabs */
    const tab = 'recent';
    const tabs = document.querySelectorAll('.tab__item');
    const panels = document.querySelectorAll('.content__panel');

    function switchTab(targetId) {
        if (targetId !== tab) {
            history.replaceState(null, null, `#${targetId}`);
        } else {
            history.replaceState(null, null, window.location.pathname);
        }

        tabs.forEach(tab => {
            tab.classList.toggle('tab__item--active', tab.getAttribute('target') === targetId);
        });

        panels.forEach(panel => {
            panel.style.display = panel.id === targetId ? 'block' : 'none';
        });
    }

    tabs.forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab.getAttribute('target')));
    });

    const handleHashChange = () => switchTab(window.location.hash.slice(1) || tab);
    window.addEventListener('hashchange', handleHashChange);
    handleHashChange();
</script>
<script>
    /* Fetch */
    Promise.all([
        fetch(`/api/containers?filter=labels:type:studio`).then(r => r.json())
    ]).then(([response]) => {
        if (!response.success) {
            console.error(response.error);
            return;
        }

        document.getElementById('recent').innerHTML = Object.entries(response.containers)
            .map(([id, container]) => `
            <a class="panel__item" href="/studio/${container.id}">
                <button class="item__more">
                    <i class="fa-sharp fa-light fa-ellipsis"></i>
                </button>
                <div style="font-size: 0.875rem;" class="item__icon">
                    <i class="fa-kit fa-studio"></i>
                </div>
                <div class="item__name">${container.id}</div>
                <div class="item__cpu">
                    <i class="fa-kit fa-cpu"></i>4 vCPU
                </div>
                <div class="item__gpu">
                    <i class="fa-kit fa-nvidia"></i>RTX 3090
                </div>
                <div class="item__status item__status--${container.status.toLowerCase()}">
                    ${container.status}
                </div>
                <div class="item__date">
                    34 Minutes Ago
                </div>
            </a>
        `).join('');
        
        // Execute all scripts asynchronously after injection
        document.querySelectorAll('#studios-list script[async]').forEach(script => {
            setTimeout(() => {
                eval(script.textContent);
            }, 0);
        });
    });
</script>
{% endblock %}
